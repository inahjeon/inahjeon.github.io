---
layout: post
title: ë‚´ë§˜ëŒ€ë¡œ ë‰´ìŠ¤ ìš”ì•½ íë ˆì´ì…˜ (2) - AWS Lambda ë¡œ í¬ë¡¤ë§ ìë™í™”í•˜ê¸°
badges: true
comments: true
categories: [side project]
---

ë°ì´í„°ë¶„ì„ í•˜ê¸° ì „ì— ìµœê·¼ì¼ìê¹Œì§€ ë°ì´í„°ë¥¼ ë‹¤ì‹œ í¬ë¡¤ë§í•´ì™€ì•¼í•˜ëŠ” ê·€ì°®ìŒì´ ìˆì–´ì„œ ì´ë²ˆì£¼ëŠ” ë¡œì»¬ì—ì„œ ì†ìœ¼ë¡œ ëŒë¦¬ë˜ í¬ë¡¤ë§ì„ ìë™í™”í•˜ê¸°ë¡œ í–ˆë‹¤.

## 0. ì–´ë–»ê²Œ ë§Œë“¤ì–´ ë³¼ê¹Œ?

ê°œì¸ aws ê³„ì •ì„ ì‚¬ìš©í•  ì˜ˆì •ì´ê¸° ë•Œë¬¸ì—, ë‹¤ë¥¸ê±´ ë‹¤ í•„ìš”ì—†ê³  ê°€ì¥ ì €ë ´í•˜ê²Œ ìë™í™”ëœ ë°ì´í„° ìˆ˜ì§‘ íŒŒì´í”„ë¼ì¸ì„ ë§Œë“¤ê³  ì‹¶ì—ˆë‹¤.

ì°¾ì•„ë³´ë‹ˆ AWS Cloud watch Event Trigger -> Lambda function -> S3ì— ì €ì¥ ìœ¼ë¡œ í•˜ëŠ”ê²ƒì´ ê°€ì¥ ê²½ì œì ì´ë¼ ì¹´ë”ë¼ëŠ” ì–˜ê¸°ê°€ ë§ì•„ì„œ ì´ë ‡ê²Œ ë§Œë“¤ì–´ë³´ê¸°ë¡œ í–ˆë‹¤.

## 1. AWS Lambda Function ë§Œë“¤ê¸°

Lambda í•¨ìˆ˜ë¥¼ ë§Œë“¤ëŸ¬ ê°€ë³´ì.

Lambda ì„œë¹„ìŠ¤ì—ì„œ í•¨ìˆ˜ ìƒì„± ê¸°ëŠ¥ì„ ëˆ„ë¥´ë©´ ì•„ë˜ì™€ ê°™ì´ ë§Œë“¤ë ¤ëŠ” í•¨ìˆ˜ ì´ë¦„, ëŸ°íƒ€ì„, ê¶Œí•œì— ëŒ€í•´ì„œ ì§€ì •í•  ìˆ˜ ìˆë‹¤.

![](https://user-images.githubusercontent.com/16538186/82753054-ae03e900-9dfd-11ea-8fca-fdb93b8d1fa6.png)

ëŸ°íƒ€ì„ì€ ë‚˜ì¤‘ì— í•„ìš”í•œ selenium + chromium ë•Œë¬¸ì— python 3.6 ë²„ì „ìœ¼ë¡œ ì„¤ì •í–ˆë‹¤.

í•¨ìˆ˜ìƒì„±ì„ í•˜ë©´ ì•„ë˜ì™€ ê°™ì€ í™”ë©´ì„ ë³¼ ìˆ˜ ìˆë‹¤.

![](https://user-images.githubusercontent.com/16538186/82753076-db509700-9dfd-11ea-9416-d33eb300dad6.png)

íŠ¸ë¦¬ê±° ì¶”ê°€ì—ì„œ lambda function ì„ ì‹¤í–‰í•  ë•Œ í•„ìš”í•œ trigger ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆê³ , í•¨ìˆ˜ ì½”ë“œ ì˜ì—­ì— ì‹¤í–‰í•  ì½”ë“œë¥¼ ì§ì ‘ ì‘ì„±í•˜ê±°ë‚˜, ì••ì¶•ëœ ì‹¤í–‰ íŒŒì¼ì„ ì—…ë¡œë“œí•  ìˆ˜ ìˆë‹¤.

### 1) Layers ì— Selenium + Chromium íŒ¨í‚¤ì§€ ì°¾ì•„ì„œ ì˜¬ë¦¬ê¸°

ì˜ˆì „ì—ëŠ” lambda ì½”ë“œì—ì„œ python ê¸°ë³¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì™¸ ë‹¤ë¥¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš°, ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì™€ ìŠ¤í¬ë¦½íŠ¸ì— í•„ìš”í•œ íŒŒì´ì¬ íŒ¨í‚¤ì§€íŒŒì¼ë“¤ì„ ëª¨ë‘ í•œë°ëª¨ì•„.... zipìœ¼ë¡œ ì••ì¶•í•´ì„œ ì˜¬ë ¤ì£¼ì–´ì•¼ í–ˆë‹¤.

![](https://user-images.githubusercontent.com/16538186/82753283-74cc7880-9dff-11ea-8244-5664537a9304.png)
(lambda_function.zip...)

ê·¸ëŸ°ë° ìµœê·¼ì—ëŠ” `Layers` ë¼ëŠ” ê¸°ëŠ¥ì´ ì¶”ê°€ë˜ì–´ì„œ **í•„ìš”í•œ íŒ¨í‚¤ì§€ íŒŒì¼ì„ ë”°ë¡œ Layerì— ë„£ì–´ë‘˜ ìˆ˜ ìˆê³ , ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œì—ì„œ Layer ì— ìˆëŠ” íŒ¨í‚¤ì§€ë¥¼ import** í•  ìˆ˜ ìˆë„ë¡ ë¶„ë¦¬ë˜ì—ˆë‹¤. (~~ì˜¤ì˜ˆ!~~)

ì‚¬ì‹¤ ì˜ˆì „ì— lambda í•¨ìˆ˜ë¥¼ ì¨ë³´ë ¤ê³  í•  ë•Œ í…ŒìŠ¤íŠ¸ í™˜ê²½ì´ ë¶ˆí¸í•´ì„œ ì˜ ì“°ì§€ ëª»í–ˆì—ˆë‹¤. íŠ¹íˆ ì™¸ë¶€ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì“°ëŠ” ê²½ìš°ë‚˜, lambda ì‹¤í–‰ í™˜ê²½ì—ì„œ í¬ë¡¤ë§ì— í•„ìš”í•œ headless chrome driverë¥¼ í…ŒìŠ¤íŠ¸ í•´ë³´ëŠ” ê²½ìš° ë”ë”ìš± ì‹œê°„ì´ ë§ì´ ë“¤ê³  ì–´ë ¤ì› ë‹¤.
ê·¸ëŸ°ë° Layers ê¸°ëŠ¥ì´ ìƒê¸°ë©´ì„œ Layerì— í•„ìš”í•œ íŒ¨í‚¤ì§€ë¥¼ ì˜¬ë ¤ë‘ê³  ìŠ¤í¬ë¦½íŠ¸ ì½”ë“œë§Œ ì‘ì„±í•  ìˆ˜ ìˆê²Œ ë˜ì–´ì„œ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë„ ê°€ëŠ¥í•´ì¡Œë‹¤.

ì°¾ì•„ë³´ë‹ˆ ë¡œì»¬ì—ì„œ í…ŒìŠ¤íŠ¸í•  ë•ŒëŠ” AWS lambda ì˜ ì‹¤í–‰í™˜ê²½ì— ë§ì¶˜ [lambci](https://github.com/lambci) ì—ì„œ ì œê³µí•˜ëŠ” docker ì´ë¯¸ì§€ íŒŒì¼ë¡œ í…ŒìŠ¤íŠ¸ í•´ë³¼ ìˆœ ìˆë‹¤ê³  í•œë‹¤. í•˜ì§€ë§Œ ê·¸ëƒ¥ ë°”ë¡œ editor ì—ì„œ í…ŒìŠ¤íŠ¸í•˜ëŠ”ê²Œ ì œì¼ í¸í•˜ë‹¤.

ê·¸ëŸ¬ë©´ ë‚˜ì—ê²Œ í•„ìš”í•œ ê±´ **í¬ë¡¤ë§ ì½”ë“œë¥¼ ëŒë¦¬ê¸° ìœ„í•œ selenium + chrome driver Layer** ê°€ í•„ìš”í•˜ë‹¤.

lambda ë¥¼ ì´ìš©í•´ì„œ selenium ìœ¼ë¡œ í¬ë¡¤ë§í•˜ëŠ” ê±´ ì´ì „ì— ë§¤ìš° ë§ì€ í›Œë¥­í•˜ì‹  ë¶„ë“¤ì´ ë§ì€ ì‚½ì§ˆì„ í•´ ë‘ì—ˆì„ ê²ƒì´ë¯€ë¡œ, ì—´ì‹¬íˆ êµ¬ê¸€ë§í•´ë³´ë‹ˆ ë°”ë¡œ êµ¬í•  ìˆ˜ ìˆì—ˆë‹¤.

ê²€ìƒ‰í•´ì„œ ë‚˜ì˜¨ ì—¬ëŸ¬ ê²°ê³¼ ì¤‘ [https://github.com/inahjeon/AWS-LAMBDA-LAYER-Selenium](https://github.com/inahjeon/AWS-LAMBDA-LAYER-Selenium) ì— ì˜¬ë ¤ì§„ íŒŒì¼ì„ ì‚¬ìš©í–ˆë‹¤.

SELENIUM_LAYER.zip ì„ ë°›ì•„ì„œ Layer ì— ë“±ë¡í•˜ì. 

`Layers` -> `create layer` ì—ì„œ zip íŒŒì¼ë§Œ ì—…ë¡œë“œ í•´ì£¼ë©´ ë“±ë¡ë˜ê³ , lambda function ì—ì„œ `add a layer` ë¡œ ë“±ë¡í•œ layer ë¥¼ ì„ íƒí•´ì„œ ì¶”ê°€í•´ì£¼ë©´ ëœë‹¤.

í¬ë¡¤ë§ ì½”ë“œëŠ” ì‹¤í–‰ ì‹œê°„ì´ ì¢€ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— timeout ì„¤ì •ì„ 1ë¶„ ì´ìƒ ì§€ì •í•´ì£¼ì.

![](https://user-images.githubusercontent.com/16538186/82753701-a561e180-9e02-11ea-986a-364089afd962.png)

import ê°€ ì˜ëœë‹¤! ì˜¤ëŠ˜ í•˜ëŠ” ê²ƒ ì¤‘ ê°€ì¥ ë‚œì´ë„ ì–´ë ¤ìš´ ë¶€ë¶„ì´ ì‰½ê²Œ í•´ê²°ë˜ì—ˆë‹¤! (ë©ì‹¤ë©ì‹¤) 

### 2) Cloud Watch Event Trigger ì„¤ì •í•˜ê¸°

ì´ë²¤íŠ¸ íŠ¸ë¦¬ê±°ëŠ” `add trigger` ë¡œ ë“¤ì–´ê°€ì„œ CloudWatch Events/EventBridge ë¥¼ ì„ íƒí•˜ê³  ì•„ë˜ì™€ ê°™ì´ ë§Œë“¤ ìˆ˜ ìˆë‹¤.

![](https://user-images.githubusercontent.com/16538186/82753850-08a04380-9e04-11ea-9833-1058942a303e.png)

ë§¤ì¼ ìƒˆë²½ 1ì‹œì— ì‹¤í–‰ë˜ë„ë¡ í–ˆë‹¤.

### 3) s3ì— ê²°ê³¼ ì €ì¥í•˜ê¸°

ì´ì œ s3ì— í¬ë¡¤ë§í•œ ê²°ê³¼ë¥¼ ì €ì¥í•´ë³´ì.

ì¼ë‹¨ lambda function ì— ì—°ê²°ëœ ê¶Œí•œì— s3 ì ‘ê·¼ ê¶Œí•œë„ ì¶”ê°€í•´ì£¼ì–´ì•¼ í•œë‹¤.

![](https://user-images.githubusercontent.com/16538186/82753970-e4913200-9e04-11ea-9d6e-97581eb1afdf.png)

IAM -> ì—­í•  ì—ì„œ ì—°ê²°ëœ ì—­í• ì„ ì„ íƒí•˜ê³  ì •ì±…ì—°ê²°ì„ ëˆŒëŸ¬ `AmazonS3FullAccess` ê¶Œí•œì„ ì¶”ê°€ í•´ì¤€ë‹¤. (ì„¸ë°€í•œ ê¶Œí•œ ì„¤ì •ì€ ì˜ ëª¨ë¥´ë¯€ë¡œ íŒ¨ìŠ¤)

ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì›¹í˜ì´ì§€ë¥¼ s3ì— ì €ì¥í•˜ëŠ” ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸í•´ë³´ì.

```python
def lambda_handler(event, context):
    driver = get_driver()
    driver.get('https://www.google.com/')
    page_data = driver.page_source
    driver.close()
    
    encoded_string = page_data.encode("utf-8")

    file_name = f"test.txt"
    s3_path = f"test/" + file_name

    s3 = boto3.resource("s3")
    s3.Bucket(BUCKET_NAME).put_object(Key=s3_path, Body=encoded_string)
    
    return page_data
```

![](https://user-images.githubusercontent.com/16538186/82754141-f9ba9080-9e05-11ea-9f71-9b5c765f59d6.png)

í¬ë¡¤ë§í•œ ë°ì´í„°ê°€ ì˜ ì €ì¥ëœë‹¤.

ì´ì œ í•„ìš”í•œ ê¸°ëŠ¥ë“¤ì€ ë‹¤ í…ŒìŠ¤íŠ¸í–ˆê³ , [ì´ì „ì— ì‘ì„±í•´ ë‘” í¬ë¡¤ë§ ì½”ë“œ](https://inahjeon.github.io/devlog/side%20project/2020/04/26/news1.html#(3)-%ED%81%AC%EB%A1%A4%EB%A7%81-%EC%BD%94%EB%93%9C-%EC%9E%91%EC%84%B1)ë§Œ ì ì ˆíˆ ë³€ê²½í•´ì„œ ë„£ì–´ì£¼ë©´ ëœë‹¤.

## 2. ë‰´ìŠ¤ í¬ë¡¤ë§ í•˜ê¸°

ì´ì „ ê¸€ì—ì„œ ì‘ì„±í•´ ë‘ì—ˆë˜ ì½”ë“œë¥¼ ì¡°ê¸ˆ ë³€ê²½í•˜ì—¬ ë§¤ì¼ë§¤ì¼ ê·¸ë‚ ì˜ ì¸ê¸°ë‰´ìŠ¤ ë¦¬ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì™€ì„œ s3ì— ì €ì¥í•˜ëŠ” ì½”ë“œë¡œ ë³€ê²½í–ˆë‹¤.

```python
import os
from datetime import datetime, timezone, timedelta

import boto3
from selenium.webdriver.chrome.options import Options
from selenium import webdriver


BUCKET_NAME = os.getenv('BUCKET_NAME', '')


def get_driver():
    chrome_options = Options()
    chrome_options.add_argument('--headless')
    chrome_options.add_argument('--no-sandbox')
    chrome_options.add_argument('--disable-gpu')
    chrome_options.add_argument('--window-size=1280x1696')
    chrome_options.add_argument('--user-data-dir=/tmp/user-data')
    chrome_options.add_argument('--hide-scrollbars')
    chrome_options.add_argument('--enable-logging')
    chrome_options.add_argument('--log-level=0')
    chrome_options.add_argument('--v=99')
    chrome_options.add_argument('--single-process')
    chrome_options.add_argument('--data-path=/tmp/data-path')
    chrome_options.add_argument('--ignore-certificate-errors')
    chrome_options.add_argument('--homedir=/tmp')
    chrome_options.add_argument('--disk-cache-dir=/tmp/cache-dir')
    chrome_options.add_argument('user-agent=Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/61.0.3163.100 Safari/537.36')
    chrome_options.binary_location = "/opt/python/bin/headless-chromium"

    driver = webdriver.Chrome('/opt/python/bin/chromedriver', chrome_options=chrome_options)
    return driver
	
_SECTIONS = {
    '100': 'ì •ì¹˜',
    '101': 'ê²½ì œ',
    '102': 'ì‚¬íšŒ',
    '103': 'ìƒí™œ/ë¬¸í™”',
    '104': 'ì„¸ê³„',
    '105': 'IT/ê³¼í•™'
}

def write_to_s3(date_str, news_type, data: str):
    encoded_string = data.encode('utf-8')
    file_name = f'{date_str}.txt'
    s3_path = f'{news_type}/' + file_name

    s3 = boto3.resource('s3')
    s3.Bucket(BUCKET_NAME).put_object(Key=s3_path, Body=encoded_string)


def get_popular_day_news_contents(driver, date_str, section_id):
    url = f'https://news.naver.com/main/ranking/popularDay.nhn' \
        f'?rankingType=popular_day' \
        f'&sectionId={section_id}&date={date_str}'
    driver.get(url)
    driver.implicitly_wait(1)

    ranking = driver.find_elements_by_class_name('ranking')

    if ranking:
        headlines = ranking[0].find_elements_by_class_name('ranking_headline')
        ledes = ranking[0].find_elements_by_class_name('ranking_lede')
        offices = ranking[0].find_elements_by_class_name('ranking_office')
        views = ranking[0].find_elements_by_class_name('ranking_view')

        return zip(headlines, ledes, offices, views)
    else:
        return None


def lambda_handler(event, context):
    tz = timezone(timedelta(hours=9))
    kst_dt = datetime.now().astimezone(tz)
    date_str = kst_dt.strftime('%Y%m%d')
    
    driver = get_driver()
    
    columns = ['date', 'section', 'office', 'view', 'headline', 'lede', 'link']
    data = []
    data.append('\t'.join(columns) + '\n')
    
    for section_id, section_name in _SECTIONS.items():
            contents = get_popular_day_news_contents(driver, date_str, section_id)
            if contents:
                for headline, lede, office, view in contents:
                    headline_a_tag = headline.find_element_by_tag_name('a')
                    contents = '\t'.join([
                        date_str,
                        section_name,
                        office.text,
                        view.text,
                        headline_a_tag.get_attribute('title'),
                        lede.text,
                        headline_a_tag.get_attribute('href')
                    ])
                    data.append(contents + '\n')
    write_to_s3(date_str, 'popular_day', ''.join(data))
    
    driver.close()
```

## 3. ê²°ê³¼ë¬¼ í™•ì¸

Testë¡œ Cloud Watch Event trigger ì—ì„œ ì„ì‹œë¡œ 1ë¶„ ë’¤ì¸ ì˜¤í›„ 9ì‹œ 40ë¶„ìœ¼ë¡œ ìŠ¤ì¼€ì¥´ë§í•´ì„œ ê¸°ë‹¤ë ¤ë³¸ë‹¤.

![](https://user-images.githubusercontent.com/16538186/82754441-e3153900-9e07-11ea-8754-fe213b3350f2.png)

ì˜¤í›„ 9ì‹œ 42ë¶„ì— jobì´ ì¢…ë£Œë˜ì—ˆê³  s3ì— ë°ì´í„°ë¥¼ ì˜ ì €ì¥í•œ ê±¸ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

![](https://user-images.githubusercontent.com/16538186/82754442-e7415680-9e07-11ea-8ec7-886b7c799d38.png)

ê±¸ë¦°ì‹œê°„ì€ `89400ms`, ë©”ëª¨ë¦¬ëŠ” `340MB` ì •ë„ ì‚¬ìš©í•œë‹¤ê³  í•œë‹¤.

Lambda ìš”ê¸ˆì„ ë³´ë©´ ë©”ëª¨ë¦¬ 512MBì— 100ms ë‹¹ 0.0000008333 USD ë¼ê³  í•˜ë‹ˆ, 1ë…„ 365ì¼ ëŒë¦¬ë©´ $28 ë‹¬ëŸ¬ ì •ë„ë‹¤.

ê²°ê³¼ë¬¼ì´ ë§¤ìš° ë§Œì¡±ìŠ¤ëŸ½ë‹¤. ìë™í™” ì¹­ì°¬í•´. ğŸ‘ğŸ‘ğŸ‘
